<!-- 2.7.4 -->
## Идентификатор роутера OSPF

OSPFv2 включается с помощью команды режима глобальной настройки **router ospf** *process-id*. Значение *process-id* представляет собой число от 1 до 65535 и выбирается сетевым администратором. Идентификатор роутера OSPF — это 32-разрядное значение, представленное в формате адреса IPv4, используется маршрутизатором с поддержкой OSPF для синхронизации баз данных OSPF и участия в выборе DR и BDR. Роутеры Cisco получают идентификатор на основе одного из трех критериев в следующем предпочтительном порядке:

1.  идентификатор задается с помощью команды **router-id** *rid*, выполняемой в режиме конфигурации устройства OSPF представляет собой любое 32-разрядное число в формате адреса IPv4;
2.  если идентификатор не настроен напрямую, роутер выбирает самое высокое значение IPv4-адреса любого из настроенных интерфейсов loopback;
3.  при отсутствии настроенных интерфейсов loopback роутер выбирает самое высокое значение активного IPv4-адреса любого из своих физических интерфейсов.

Идентификатор роутера также можно назначить, используя интерфейс loopback. IPv4-адрес для этого типа интерфейса обратной связи должен быть настроен с использованием 32-битной маски подсети (255.255.255.255), создающей маршрут хоста. 32-битный маршрут узла не объявляется в качестве маршрута для других устройств OSPF. После того, как устройство выбирает идентификатор, активный роутер OSPF не позволяет изменять идентификатор, пока не будет перезагружен или процесс OSPF не будет сброшен. Используйте  команду **clear ip ospf process** для сброса смежности. Затем можно убедиться в том, что R1 использует новый router ID с командой **show ip protocols** с фильтром для отображения только раздела идентификатора.

## Сети OSPF типа «точка-точка»

Команда network определяет, какие интерфейсы участвуют в процессе маршрутизации для области OSPFv2. Базовый синтаксис команды — **network** **network**_network-address_ _wildcard-mask_ **area** _area-id._ Любые интерфейсы роуера, соответствующие сетевому адресу в **network** команде, могут отправлять и принимать пакеты OSPF. При настройке конфигурации OSPFv2 для одной области команда **network** должна использоваться с одним и тем же значением.
Шаблонная маска обычно является обратной маской подсети, настроенной на этом интерфейсе. В шаблонной маске:

* **бит 0 шаблонной маски**  — совпадает с соответствующим значением бита в адресе;
* **бит 1 шаблонной маски** — игнорирует соответствующее значение бита в адресе.

В режиме конфигурации маршрутизации существует два способа определения интерфейсов, которые будут участвовать в процессе маршрутизации OSPFv2. Один из способов заключается в том, что  шаблонная маска идентифицирует интерфейс на основе сетевых адресов. Любой активный интерфейс, настроенный с адресом IPv4, принадлежащим этой сети, будет участвовать в процессе маршрутизации OSPFv2. Другой способ — OSPFv2 может быть включен, указав точный адрес IPv4 интерфейса с помощью маски из четырех нулей. Чтобы настроить OSPF непосредственно на интерфейсе, используйте команду конфигурации интерфейса **ip ospf**. Синтаксис **ip ospf** _process-id_ **area** _area-id._. Отправка нежелательных сообщений по локальной сети влияет на сеть из-за неэффективного использования полосы пропускания и ресурсов и создает повышенный риск безопасности. Используйте команду режима конфигурации роутера **passive-interface**, чтобы запретить передачу сообщений маршрутизации посредством его интерфейса и при этом разрешить объявление этой сети для других устройств, как показано на рис. 1. Команда **show ip protocols** используется для проверки того, что интерфейс Loopback 0 указан как пассивный. Процесс выборов DR/BDR не нужен, так как в сети точка-точка между R1 и R2 может быть только два роутера. Используйте команду конфигурации для всех интерфейсов **ip ospf network point-to-point**, на которых требуется отключить процесс выбора DR/BDR. Используйте петли для моделирования большего количества сетей, чем может поддерживать оборудование. По умолчанию интерфейсы loopback объявляются как хост-маршруты /32. Для имитации реальной локальной сети интерфейс Loopback 0 настраивается как сеть точка-точка.

## Типы сетей OSPF

Роутеры могут быть подключены к одному и тому же коммутатору для формирования сети с множественным доступом. Локальные сети Ethernet — это наиболее распространённый пример широковещательных таких сетей. В широковещательных сетях все устройства в рамках сети видят все широковещательные кадры и кадры групповой рассылки. DR отвечает за сбор и распространение LSAs, а также использует IPv4-адрес многоадресной рассылки 224.0.0.5, который предназначен для всех устройств OSPF. Если DR перестает создавать пакеты приветствия (hello), то BDR самостоятельно принимает роль DR. Все остальные устройства приобретают статус DROthers. DROTHER используют адрес с несколькими доступом 224.0.0.6 (все назначенные роутеры) для отправки пакетов OSPF в DR и BDR. Только DR и BDR прослушивают 224.0.0.6. Для проверки ролей устройства OSPFv2 используйте команду **show ip ospf interface**. Для проверки отношений смежности OSPFv2 используйте команду **show ip ospf neighbor**. У соседей в сетях со множественным доступом могут быть следующие состояния:

* **FULL/DROTHER** – выделенный роутер (DR или BDR), который полностью смежен с невыделенным (не DR и не BDR);
* **FULL/DR** – роутер, полностью смежный с указанным соседом DR;
* **FULL/BDR** – роутер, полностью смежный с указанным соседом BDR;
* **2-WAY/DROTHER** – невыделенный маршрутизатор (не DR и не BDR), у которого имеются отношения смежности с другим невыделенным маршрутизатором (не DR и не BDR).

Выбор ролей DR и BDR по протоколу OSPF основывается на следующих критериях в указанной очередности:

1.  устройства в сети выбирают роутер с самым высоким приоритетом интерфейса в качестве DR. Роутрер со вторым по величине приоритетом интерфейса становится BDR. Приоритет может быть представлен любым числом от 0 до 255. Если значение приоритета интерфейса равно 0, этот интерфейс не может быть выбран как DR или BDR. Приоритет по умолчанию интерфейсов, подключенных к широковещательной сети множественного доступа, равен 1. Соответственно, при отсутствии иных настроек, все устройства обладают равным приоритетом, и для выборов DR/BDR будет использоваться другой метод.
2.  если приоритеты интерфейсов равны, то в качестве DR будет выбран роутер с наивысшим идентификатором. Устройство со вторым по величине идентификатором становится BDR.

Процесс выбора DR и BDR по протоколу OSPF не является вытесняющим. Если происходит сбой DR, то его роль автоматически перенимает BDR. Это происходит даже в том случае, если после первоначального выбора DR/BDR к сети добавляется DROTHER с более высоким идентификатором или приоритетом. Однако когда BDR перенимает роль DR, происходит новый выбор BDR и его роль получает роутер DROTHER с высоким идентификатором или приоритетом. Для задания приоритета интерфейса используйте команду **ip ospf priority** _value_, где значение от 0 до 255. Если значение равно 0, роутер не станет DR или BDR. При значениях от 1 до 255 — чем выше значение приоритета, тем больше вероятность того, что роутер станет DR или BDR на данном интерфейсе.

## Изменение OSPFv2 для одной области

Протокол OSPF использует стоимость в качестве метрики. Путь с более низкой стоимостью является оптимальным. Стоимость интерфейса обратно пропорциональна его пропускной способности. Следовательно, более высокая пропускная способность указывает на более низкую стоимость. Формула, используемая для расчета стоимости OSPF: Стоимость = базовая пропускная способность/пропускная способность интерфейса. Обратите внимание, что интерфейсы FastEthernet, Gigabit Ethernet и 10 GigE используют одинаковое значение стоимости, поскольку значение стоимости OSPF должно быть целым числом. Чтобы исправить эту ситуацию, можно настроить опорную пропускную способность с помощью команды **auto-cost reference-bandwidth** на каждом устройстве OSPF или вручную задать значение стоимости OSPF с помощью команды **ip ospf cost**. Чтобы отрегулировать эталонную пропускную способность, используйте команду конфигурации устройства **auto-cost reference-bandwidth** Mb/s. Стоимость маршрута OSPF представляет собой накопленное значение от одного маршрутизатора до сети назначения. Значения стоимости OSPF можно изменять, чтобы повлиять на маршрут, выбранный OSPF. Чтобы изменить отчет о стоимости используйте команду конфигурации интерфейса **ip ospf cost** _value_. Если интервал простоя истекает до получения пакета приветствия, то OSPF удаляет соседнее устройство из своей базы данных состояний каналов (LSDB). Роутер выполняет лавинную рассылку базы данных состояний каналов, содержащей сведения21 о неработающем соседнем устройстве, из всех интерфейсов, использующих OSPF. Cisco по умолчанию использует интервал приветствия в 4 раза больше или 40 секунд в сетях с коллективным доступом и «точка-точка»-сетях. Чтобы проверить интервал интерфейса OSPFv2, используйте команду **show ip ospf interface**. Интервалы приветствия (hello) и простоя (dead) OSPFv2 можно изменить вручную с помощью следующих команд режима интерфейсной настройки: **ip ospf hello-interval** seconds и **ip ospf dead-interval** seconds.

## Распространение маршрута по умолчанию

В терминологии OSPF роутер, расположенный между доменом маршрутизации OSPF и сетью без OSPF, называют граничным роутером автономной системы (ASBR). Для распространения маршрута по умолчанию ASBR должен быть настроен статический маршрут по умолчанию с помощью команды **ip route 0.0.0.0 0.0.0.0** _\[next-hop-address_ | _exit-intf\]_ и команды конфигурации роутера **default-information originate**. Благодаря этому параметру устройство становится источником информации о маршруте по умолчанию и распространяет статический маршрут по умолчанию в обновлениях OSPF. Проверьте настройки маршрута по умолчанию на ASBR с помощью команды **show ip route**.

## Проверка работы OSPFv2 для одной области

Для проверки маршрутизации используются две команды:

* **show ip interface brief** — позвволяет проверить, что необходимые интерфейсы активны с правильной IP-адресацией.
* **show ip route** — проверяет, что таблица маршрутизации содержит все ожидаемые маршруты.

Дополнительные команды для проверки работы OSPF: **show ip ospf neighbor**, **show ip protocols**, **show ip ospf** и **show ip ospf interface**.

Чтобы убедиться, что маршрутизатор сформировал отношения смежности с соседними маршрутизаторами, используется команда **show ip ospf neighbor**. Для каждого соседнего устройства данная команда отображает следующие выходные данные:

* **neighbor ID** — идентификатор соседнего устройства;
* **pri** — приоритет интерфейса OSPFv2, используется при выборе DR и BDR;
* **state** — состояние интерфейса OSPFv2. Состояние FULL означает, что данный и соседний роутеры имеют одинаковые базы данных состояния каналов OSPFv2. В сетях с множественным доступом (например, Ethernet) состояние двух устройств, состоящих в отношениях смежности, может отображаться как 2WAY. Тире указывает, что использование в данном типе сети DR или BDR не требуется;
* **dead time** — время, которое роутер ожидает получения пакета приветствия OSPFv2 перед объявлением соседнего устройства неработающим. Данное значение сбрасывается при получении интерфейсом пакета приветствия;
* **address** — IPv4-адрес интерфейса соседнего устройства, к которому напрямую подключен роутер;
* **interface** — интерфейс, на котором роутер установил отношения смежности с соседним устройством.

Команда **show ip protocols** позволяет быстро проверить следующую информацию о конфигурации OSPF:

- идентификатор процесса OSPFv2;
- идентификатор роутера;
- интерфейсы, явно настроенные для объявления маршрутов OSPF;
- соседи, с которых роутер получает обновления;
- административное расстояние по умолчанию, равное 110 для OSPF. 

Для проверки идентификатора процесса OSPF и идентификатора роутера используйте команду **show ip ospf**. Она отображает данные области OSPFv2 и показывает время последнего расчета алгоритма SPF. Команда **show ip ospf interface** выводит подробный список для каждого интерфейса, где включен OSPFv2. Укажите интерфейс для одного для отображения идентификатора процесса, идентификатора локального маршрутизатора, типа сети, стоимости OSPF, информации о DR и BDR на многоканальных каналах и соседних устройствах.

<!-- 2.7.5 -->
<!-- quiz -->

