<!-- 6.8.3 -->
## Характеристики технологии NAT

Количества публичных IPv4-адресов недостаточно, чтобы назначить уникальные адреса всем устройствам, подключенным к Интернету. Частные адреса IPv4 нельзя использовать для маршрутизации в Интернете. Для того чтобы разрешить устройству с частным IPv4-адресом получать доступ к устройствам и ресурсам вне локальной сети, частный адрес сначала необходимо преобразовать в публичный адрес. NAT обеспечивает преобразование частных адресов в публичные адреса. Основной задачей NAT является экономия публичных IPv4-адресов. Это достигается за счет того, что для внутреннего взаимодействия в сетях используются частные IPv4-адреса, а преобразование в публичные адреса происходит только в случае необходимости. Если внутреннее устройство отправляет трафик за пределы сети, роутер с поддержкой NAT преобразует внутренний IPv4-адрес устройства в публичный адрес из пула NAT. В терминологии NAT под «внутренней сетью» подразумевается набор сетей, чьи адреса будут транслироваться. Термин «внешняя сеть» относится ко всем остальным сетям. При определении используемого типа адреса важно помнить, что терминология NAT всегда применяется с точки зрения устройства, адрес которого будет транслироваться:

* **внутренний адрес** — это адрес устройства, преобразуемый механизмом NAT;
* **внешний адрес** — это адрес устройства назначения.

В рамках NAT по отношению к адресам также используется понятие локальности или глобальности:

* **локальный адрес** — это любой адрес, появляющийся во внутренней части сети;
* **глобальный адрес** — это любой адрес, появляющийся во внешней части сети.

## Типы преобразования NAT

Статический NAT использует сопоставление локальных и глобальных адресов по схеме «один в один». Эти соответствия задаются администратором сети и остаются неизменными. Метод статического преобразования особенно полезен для веб-серверов или устройств, которые должны иметь постоянный адрес, доступный из Интернета — например, для веб-сервера компании. Для статического NAT требуется достаточное количество публичных адресов, доступных для общего количества одновременных сеансов пользователей. При динамическом преобразовании NAT используется пул публичных адресов, которые назначаются в порядке очереди («первым пришел — первым обслужили»). Когда внутреннее устройство запрашивает доступ к внешней сети, динамическое преобразование NAT назначает доступный публичный IPv4-адрес из пула. Как и для статического NAT, для динамического NAT требуется достаточное количество публичных адресов, способное обеспечить общее количество одновременных сеансов пользователей. Преобразование адреса и номера порта (PAT), также называемое NAT с перегрузкой, сопоставляет множество частных IPv4-адресов одному или нескольким публичным IPv4-адресам. Это наиболее распространенная форма NAT как для дома, так и для предприятия. PAT гарантирует, что устройства будут использовать разные номера портов TCP для каждого сеанса взаимодействия с сервером в Интернете. Преобразование PAT пытается сохранить оригинальный порт источника. В том случае, если первоначальный порт источника уже используется, PAT назначает первый доступный номер порта, начиная с наименьшего в соответствующей группе портов. PAT преобразует большинство основных протоколов, передаваемых с помощью IPv4 и не использующих TCP или UDP в качестве протокола транспортного уровня. Самым распространенным среди таких протоколов является протокол ICMPv4.

| **NAT** | **PAT** |
| --- | --- |
| сопоставление локальных и глобальных адресов по схеме «один к одному» | один внутренний глобальный адрес может быть сопоставлен со многими внутренними локальными адресами |
| в процессе преобразования использует только адреса IPv4 | использует IPv4 адреса и номера портов источника TCP или UDP в процессе преобразования |
| уникальный внутренний глобальный адрес необходим для каждого внутреннего узла, обращающегося к внешней сети | один уникальный внутренний глобальный адрес может быть общим для многих внутренних узлов, обращающихся к внешней сети |

## Преимущества и недостатки NAT

Преимущества: сохраняет официально зарегистрированную схему адресации, разрешая частное использование внутренних сетей; повышает гибкость подключений к публичной сети; обеспечивает постоянство схем внутренней сетевой адресации; скрывает IPv4-адреса конечного пользователя.

Недостатки: увеличивает задержки пересылки, поскольку преобразование каждого IPv4-адреса в заголовках пакетов требует времени. Этот процесс преобразования двух уровней NAT известен как Carrier Grade NAT, CGN. Конечная адресация теряется. Многие интернет-протоколы и приложения зависят от сквозной адресации от источника до узла назначения. Кроме того, утрачивается возможность сквозной трассировки IPv4. Использование NAT также усложняет работу с туннельными протоколами, такими как IPsec, поскольку преобразование NAT изменяет значения в заголовках, что приводит к сбою проверки целостности.

## Статическое преобразование NAT

Статическое преобразование NAT — это взаимно-однозначное сопоставление внутреннего и внешнего адресов. Статический NAT позволяет внешним устройствам инициировать подключение к внутренним устройствам с помощью статически назначенного публичного адреса. Первой задачей является создание соответствия между внутренним локальным и внутренним глобальным адресами, используя команду **ip nat inside source static**. После настройки соответствия интерфейсы, участвующие в преобразовании, настраиваются как внутренние или внешние относительно NAT, используя команды **ip nat inside** и **ip nat outside**. Для проверки функции NAT используйте команду **show ip nat translations**. Чтобы убедиться в правильности работы преобразования NAT, перед тестированием рекомендуется очистить статистику всех предыдущих преобразований с помощью команды **clear ip nat statistics**.

## Динамическое  преобразование NAT

Динамический NAT автоматически сопоставляет внутренние локальные адреса с внутренними глобальными адресами. Для динамического NAT, как и для статического NAT, требуется настройка внутреннего и внешнего интерфейсов, участвующих в преобразовании NAT. Динамический NAT использует пул адресов, преобразующий один внутренний адрес в один внешний адрес. Пул публичных IPv4-адресов (внутренний пул глобальных адресов) доступен любому устройству во внутренней сети по принципу очереди («первым пришел — первым обслужили»). Для этого типа преобразования в пуле должно быть достаточно адресов, чтобы охватить все внутренние устройства, которым требуется параллельный доступ к внешней сети. Если использованы все адреса пула, устройство должно дождаться доступного адреса, чтобы получить доступ к внешней сети.

Чтобы настроить динамический NAT, сначала определите пул адресов, который будет использоваться для перевода, с помощью команды **ip nat pool**. Эти адреса определяются с помощью указания начального и конечного IPv4-адресов пула. Ключевое слово **netmask** или **prefix-length** указывают, какие биты адреса относятся к сети, а какие — к диапазону адресов узлов. Настройте стандартный ACL, чтобы определить (разрешить) только те адреса, которые должны быть преобразованы. Привяжите ACL к пулу, используя следующий синтаксис команды: Router(config)# **ip nat inside source list** {_access-list-number_ | _access-list-name_} **pool** _pool-name_. Укажите интерфейсы, являющиеся внутренними по отношению к NAT. Укажите интерфейсы, являющиеся внешними по отношению к NAT.

Чтобы проверить настройку NAT: команда **show ip nat translations** отображает все настроенные статические преобразования адресов и все динамические преобразования, созданные в результате обработки трафика. Добавление ключевого слова **verbose** выводит дополнительную информацию о каждом преобразовании, включая время, прошедшее после создания и использования записи. По умолчанию срок действия записей преобразования истекает через 24 часа, если настройка таймеров не была изменена с помощью команды режима глобальной конфигурации **ip nat translation timeout** _timeout-seconds_ Для удаления динамических записей до истечения их времени действия используйте команду привилегированного режима EXEC **clear ip nat translation**.

## PAT

В зависимости от способа выделения публичных IPv4-адресов интернет-провайдером существуют два способа настройки PAT. 215/5000В первом случае поставщик услуг Интернета выделяет один общедоступный IPv4-адрес, который требуется организации для подключения к поставщику услуг Интернета, а в другом случае он выделяет более одного общедоступного адреса IPv4 для организации. Чтобы настроить PAT на использование одного IPv4-адреса, просто добавьте ключевое слово **overload** в **ip nat inside source** команду. Остальная часть конфигурации аналогична статической и динамической конфигурации NAT, за исключением того, что при использовании PAT несколько узлов могут использовать один и тот же публичный IPv4 адрес для доступа в Интернет. Чтобы настроить PAT для динамического пула адресов NAT, просто добавьте ключевое слово **overload** в **ip nat inside source** команду. Несколько узлов могут совместно использовать IPv4-адрес из пула, поскольку PAT включен с помощью ключевого слова **overload**.

Для проверки конфигураций PAT используйте команду **show ip nat translations**. Для различения этих двух транзакций в таблице NAT используются номера портов источников. Команда **show ip nat statistics** проверяет, что NAT-POOL выделил один адрес для нескольких переводов. В выходных данных команды содержатся сведения о количестве и типе активных преобразований, параметрах настройки NAT, количестве адресов в пуле и количестве выделенных адресов.

## NAT64

Протокол IPv6 был разработан, чтобы устранить необходимость в NAT для IPv4 с его преобразованием между публичными и частными IPv4-адресами. Однако IPv6 включает собственное частное адресное пространство IPv6, уникальные локальные адреса (ULAs). Уникальные локальные IPv6-адреса (unique local addresses, ULA) похожи на частные адреса RFC 1918 в IPv4, но при этом существенно отличаются от них. Адреса ULA предназначены только для локальной связи внутри сайта. Адреса ULA не предназначены для предоставления дополнительного адресного пространства IPv6 или для обеспечения уровня безопасности; однако IPv6 обеспечивает преобразование протокола между IPv4 и IPv6, известным как NAT64. NAT для IPv6 используется в совсем другом контексте, нежели NAT для IPv4. Разнообразные варианты NAT для IPv6 используются с целью предоставления прозрачного доступа между сетями, в которых используется только протокол IPv6, и сетями, в которых используется только протокол IPv4. Организация IETF разработала несколько методов перехода для различных сценариев перехода от IPv4 к IPv6, включая использование двойного стека, туннелирование и трансляцию адресов. Двойной стек применяется, когда устройства запускают набор протоколов и для IPv4, и для IPv6. Туннелирование для IPv6 — это процесс инкапсуляции пакетов IPv6 в пакеты IPv4. Данный метод позволяет передавать пакет IPv6 по сети, в которой используется только протокол IPv4. NAT для IPv6 следует использовать не как долгосрочную стратегию, а лишь как временный механизм, помогающий перейти с IPv4 на IPv6.

<!-- 6.8.4 -->
<!-- quiz -->
