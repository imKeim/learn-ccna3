<!-- 1.3.1 -->
## Видео: Принципы работы OSPF

Нажмите «Воспроизвести» на рисунке, чтобы просмотреть видео о работе OSPF.

![youtube](https://www.youtube.com/watch?v=yNiUGbVP2Xc)

<!-- 1.3.2 -->
## Рабочие состояния OSPF

Теперь, когда вы знаете о пакетах состояния канала OSPF, рассмотрим, как они работают с роутерами с поддержкой OSPF. При первом подключении роутера OSPF к сети он пытается:

* установить отношения смежности с соседними узлами;
* осуществить обмен данными маршрутизации;
* рассчитать оптимальные маршруты;
* достичь состояния сходимости.

Протокол OSPF проходит несколько состояний в процессе достижения сходимости:

| Состояние | Описание |
| --- | --- |
| **Состояние Down** | <ul><li>не получено ни одного пакета приветствия = Down</li><li>роутер отправляет пакеты приветствия</li><li>переход в состояние Init</li></ul> |
| **Состояние Init** | <ul><li>пакеты приветствия принимаются от соседних устройств, они содержат идентификатор отправляющего роутера</li><li>переход в состояние Two-Way</li></ul> |
| **Состояние Two-Way** | <ul><li>связь между двумя роутерами двунаправленная</li><li>на многоканальных каналах роутеры выбирают DR и BDR</li><li>переход в состояние ExStart</li></ul> |
| **Состояние ExStart** | <ul><li>в сетях «точка-точка» два роутера определяют какой будет инициировать обмен пакетами DBD и исходный номер последовательности пакетов DBD |
| **Состояние Exchange** | <ul><li>роутеры обмениваются пакетами DBD (описание базы данных)</li><li>если требуется дополнительная информация, выполняется переход в состояние Loading. В ином случае выполняется переход в состояние Full</li></ul> |
| **Состояние Loading** | <ul><li>LSR (запрос состояния канала) и LSU (пакет обновления состояния канала) используются для получения дополнительной информации о маршруте</li><li>маршруты обрабатываются посредством алгоритма поиска кратчайшего пути</li><li>переход в состояние Full</li></ul> |
| **Состояние Full** | <ul><li>база данных состояния канала роутера полностью синхронизирована |

<!-- 1.3.3 -->
## Установление отношений смежности с соседними устройствами

Если на интерфейсе активирован протокол OSPF, роутер должен определить наличие соседнего устройства OSPF в канале. Для этого он отправляет пакет приветствия, содержащий идентификатор маршрутизатора, из всех интерфейсов с поддержкой OSPF. Пакет Hello отправляется на зарезервированный адрес IPv4 многоадресной рассылки всех роутеров OSPF 224.0.0.5. Только устройства OSPFv2 будут обрабатывать эти пакеты. Идентификатор устройства OSPF используется процессом OSPF для уникальной идентификации каждого устройства в области OSPF. Идентификатор маршрутизатора — 32-битное число, отформатированное как IP-адрес и назначенное для его идентификации среди одноранговых устройств OSPF.

Если соседний роутер, на котором активирован протокол OSPF, получает пакет приветствия с идентификатором устройства, которое не включено в список его соседних устройств, принимающий роутер пытается установить с инициирующим отношения смежности.

**1. Из состояния Down в состояние Init**

Если OSPFv2 включен, интерфейс гигабитного Ethernet 0/0 переходит из состояния Down в состояние Init. Роутер R1 начинает отправлять пакеты приветствия из всех интерфейсов с поддержкой OSPF для обнаружения соседних устройств OSPF, с которыми следует установить отношения смежности.

![](./assets/1.3.3-1.png)
<!-- /courses/ensa-dl/ae8cded0-34fd-11eb-ba19-f1886492e0e4/aeb30472-34fd-11eb-ba19-f1886492e0e4/assets/c5892790-1c46-11ea-af56-e368b99e9723.svg -->

<!--
Схема показывает, что роутер R1 переключается с состояния OSPFv2 Down на состояние Init и многоадресная передача пакета Hello на R2.
-->

**2. Состояние Init**

Роутер R2 принимает пакет приветствия от роутера R1 и добавляет его идентификатор в список соседних устройств. После этого R2 отправляет пакет приветствия на R1. Пакет содержит идентификатор R2 и R1 в списке соседних устройств на том же интерфейсе.

![](./assets/1.3.3-2.png)
<!-- /courses/ensa-dl/ae8cded0-34fd-11eb-ba19-f1886492e0e4/aeb30472-34fd-11eb-ba19-f1886492e0e4/assets/c5899cc1-1c46-11ea-af56-e368b99e9723.svg -->

<!--
На диаграмме показано, что R2 добавляет R1 в список соседей и отправляет пакет Hello с его списком соседей в R1. 
-->

**3. Состояние Two-Way**

Роутер R1 принимает пакет приветствия и добавляет идентификатор R2 в список соседних устройств OSPF. Он также видит свой собственный идентификатор в пакете приветствия от соседних устройств. Когда роутер принимает пакет приветствия, содержащий его идентификатор в списке соседних устройств, он переходит из состояния Init в Two-Way.

Действие, выполняемое в состоянии Two-Way, определяется типом взаимодействия между смежными роутерами:

* если два смежных соседних устройства взаимодействуют посредством канала типа «точка-точка», они немедленно переходят из состояния Two-Way в фазу синхронизации базы данных;
* если роутеры взаимодействуют посредством общей сети Ethernet, необходимо выбрать выделенный роутер (DR) и резервный выделенный (BDR).

![](./assets/1.3.3-3.png)
<!-- /courses/ensa-dl/ae8cded0-34fd-11eb-ba19-f1886492e0e4/aeb30472-34fd-11eb-ba19-f1886492e0e4/assets/c589eae2-1c46-11ea-af56-e368b99e9723.svg -->

<!--
Диаграмма показывает переход R1 из состояния инициализации в  состояние Two-Way, когда он получает пакет приветствия с собственным идентификатором, указанным в качестве соседа. 
-->

**4. Выбор выделенного (DR) и резервного выделенного (BDR) роутеров**

Поскольку роутеры R1 и R2 взаимодействуют посредством сети Ethernet, из них выбираются выделенный (DR) и резервный выделенный (BDR). Как показано на рисунке, роутер R2 становится выделенным (DR), а R1 - резервным выделенным (BDR). Этот процесс выполняется только в сетях множественного доступа (например, сетях LAN стандарта Ethernet).

В целях обновления данных маршрутизации выполняется непрерывный обмен пакетами приветствия.

![](./assets/1.3.3-4.png)
<!-- /courses/ensa-dl/ae8cded0-34fd-11eb-ba19-f1886492e0e4/aeb30472-34fd-11eb-ba19-f1886492e0e4/assets/c58a8721-1c46-11ea-af56-e368b99e9723.svg -->

<!--
Диаграмма показывает, что, поскольку R1 и R2 подключены через Ethernet, они должны выполнить выбор DR и BDR, и поскольку оба они имеют один и тот же номер приоритета по умолчанию, но R2 имеет более высокий идентификатор, он выбирается DR. 
-->

<!-- 1.3.4 -->
## Синхронизация баз данных OSPF

После выхода из состояния Two-Way роутеры переходят в состояние синхронизации базы данных. Пакет приветствия используется для установления отношений смежности с соседними устройствами, в это время остальные четыре типа пакетов OSPF используются в процессе обмена и синхронизации баз данных состояний каналов. Это трехэтапный процесс, который выглядит следующим образом:

1.  определение первого роутера;
2.  обмен DBD;
3.  отправка LSR.

**1. Определение первого роутера**

В состоянии ExStart два роутера принимают решение, какой будет передавать пакеты DBD первым. Роутер с более высоким идентификатором становится первым, передающим пакеты DBD в состоянии Exchange. На рисунке у R2 идентификатор больше, поэтому он передает свои пакеты DBD первым.

![](./assets/1.3.4-1.png)
<!-- /courses/ensa-dl/ae8cded0-34fd-11eb-ba19-f1886492e0e4/aeb30472-34fd-11eb-ba19-f1886492e0e4/assets/c58b4a70-1c46-11ea-af56-e368b99e9723.svg -->

<!--
Диаграмма показывает, что после двухстороннего состояния ExStart решает, какой роутер отправляет первый пакет DBD, определяя, какой роутер имеет более высокий идентификатор. 
-->

**2. Обмен DBD**

В состоянии Exchange два роутера обмениваются одним или несколькими пакетами DBD, включающими заголовок записи LSA, который отображается в базе данных состояний каналов роутера. Записи могут содержать данные о канале или о сети. Каждый заголовок записи LSA содержит данные о типе состояния канала, адресе объявляющего роутера, стоимости канала и порядковом номере. Роутер использует порядковый номер для определения актуальности полученных данных о состоянии канала.

На рисунке R2 передаёт пакет DBD роутеру R1, после чего выполняются следующие действия:

1.  R1 подтверждает получение пакета DBD посредством пакета LSAck;
2.  R1 отправляет пакеты DBD R2;
3.  R2 отправляет подтверждение R1.

![](./assets/1.3.4-2.png)
<!-- /courses/ensa-dl/ae8cded0-34fd-11eb-ba19-f1886492e0e4/aeb30472-34fd-11eb-ba19-f1886492e0e4/assets/c58b9891-1c46-11ea-af56-e368b99e9723.svg -->

<!--
На диаграмме показано, что в состоянии Exchange каждый роутер отправляет LSA с информацией LSDB в пакетах DBD. 
-->

**3. Отправка LSR**

Роутер R1 сравнивает полученные данные с данными в его собственной базе данных состояний каналов. Если пакет DBD содержит более актуальную запись о состоянии канала, роутер переходит в состояние Loading.

На рисунке R1 отправляет пакет LSR с данными о сети 172.16.6.0 на R2, который отправляет отклик, содержащий полные данные об этой сети в пакете LSU. При этом, когда R1 принимает пакет LSU, он в ответ отправляет пакет LSAck. После чего R1 добавляет новые записи о состоянии канала в свою базу данных состояний каналов.

После того, как на все пакеты LSR для данного роутера отправлен отклик, смежные устройства считаются синхронизированными и переведёнными в состояние Full. Обновления (LSUs) отправляются в случаях:

* когда обнаруживается изменение (инкрементные обновления);
* по истечении 30 минут.

![](./assets/1.3.4-3.png)
<!-- /courses/ensa-dl/ae8cded0-34fd-11eb-ba19-f1886492e0e4/aeb30472-34fd-11eb-ba19-f1886492e0e4/assets/c58be6b2-1c46-11ea-af56-e368b99e9723.svg -->

<!--
Диаграмма показывает, что если полученные пакеты DBD содержат более актуальную информацию, роутер переходит в состояние загрузки и запрашивает дополнительную информацию с помощью пакетов LSR. После того, как все LSR были разрешены с LSUs и LSAcks, роутер переходит в полное состояние.
-->

<!-- 1.3.5 -->
## Необходимость DR

Для чего необходимо выбрать выделенный и резервный выделенный роутеры?

В сетях множественного доступа протокола OSPF сушествует две проблем, связанные с лавинной рассылкой пакетов LSA.

* **Установление большого количества отношений смежности** — сети Ethernet потенциально могут обеспечивать взаимодействие между множеством роутеров OSPF посредством общего канала. Установление отношений смежности с каждым роутером не требуется и нежелательно, так как это приводит к переизбытку пакетов LSA, которыми роутеры обмениваются в пределах одной сети.
* **Избыточная лавинная рассылка пакетов LSA** — роутеры с маршрутизацией по состоянию канала выполняют лавинную рассылку своих пакетов LSA при каждой инициализации протокола OSPF или в случае изменения топологии. Такая лавинная рассылка может стать избыточной.

Для того чтобы понять проблему, связанную с чрезмерным числом отношений смежности, необходимо знать следующую формулу:

Для любого количества роутеров (обозначенных как _n_) в сети с множественным доступом есть смежности _n (n — 1)/2_.

В качестве примера показана упрощённая топология из пяти устройств, подключенных к одной сети Ethernet множественного доступа. Без механизма, позволяющего сократить число отношений смежности, такие роутеры в совокупности образуют 10 отношений смежности:

**5 (5 – 1) / 2 = 10**

Может показаться, что это не так много, но по мере добавления роутеров в сеть, число отношений смежности существенно возрастает. Например, сеть множественного доступа с 20 роутерами создаст 190 смежностей.

**Создание отношений смежности со всеми соседними устройствами**

![](./assets/1.3.5.png)
<!-- /courses/ensa-dl/ae8cded0-34fd-11eb-ba19-f1886492e0e4/aeb30472-34fd-11eb-ba19-f1886492e0e4/assets/c58c5be3-1c46-11ea-af56-e368b99e9723.svg -->

* Число смежности n (n – 1) / 2
* n = количество устройств
* Example: 5 (5 - 1)/2 = 10 смежностей

<!--
Диаграмма показывает, что 10 смежностей требуется, когда 5 роутеров соединены между собой одним и тем же коммутатором
-->

<!-- 1.3.6 -->
##  Флуд LSA с помощью DR

Резкое увеличение числа роутеров также значительно увеличивает количество LSA, которыми обмениваются устройства. Этот флуд LSA значительно влияет на работу OSPF.

**Лавинная рассылка пакетов LSA**

Чтобы понять проблему, связанную с избыточной лавинной рассылкой пакетов LSA, просмотрите на рисунок – роутер R2 отправляет пакет LSA. Это запускает отправку пакетов LSA всеми остальными роутерами. В анимации не показаны требуемые подтверждения, которые отправляются для каждого полученного пакета LSA. Если бы все роутеры в сети множественного доступа должны были выполнять лавинную рассылку и подтверждать каждый полученный пакет LSA от всех роутеров в пределах одной сети, сетевой трафик стал бы довольно хаотичным.

![](./assets/1.3.6-1.gif)

<!--
Анимация показывает подавляющее количество трафика, когда устройства OSPF изначально заливают свои LSA.
-->

**Пакеты LSA и роутер DR**

Проблема управления большим количеством отношений смежности и лавинной рассылки пакетов LSA в сети с множественным доступом решается с помощью выделенного роутера (DR). В сетях множественного доступа протокол OSPF назначает DR как точку сбора и распространения отправленных и принятых пакетов LSA. На случай сбоя DR выбирается резервный назначенный роутер (BDR). Остальные роутеры приобретают статус DROthers. Устройство DROTHER не является DR или BDR.

**Примечание.** Роутер DR используется только для рассылки LSA. Для перенаправления всех прочих пакетов этот роутер по-прежнему будет использовать соседний из  маршрутизации.

Просмотрите анимацию, чтобы узнать о роли устройства DR.

![](./assets/1.3.6-2.gif)

<!--
Анимация показывает роль DR как сборщика и распространителя LSA в сети с множественным доступом.
-->

<!-- 1.3.7 -->
<!-- quiz -->

