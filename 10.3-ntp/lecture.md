<!-- 10.3.1 -->
## Службы  времени и календаря

Прежде чем вы действительно углубитесь в управление сетью, вам следует быть уверенным в том, что все ваши компоненты настроены на одно и то же время и дату.

Основным источником информации о времени в системе являются программные часы маршрутизатора или коммутатора, которые запускаются при загрузке системы. Важно, чтобы время на всех устройствах в сети было синхронизировано, поскольку все аспекты управления, безопасности, устранения неполадок и планирования сети требуют точных меток времени. Если время на устройствах не синхронизировано, определить порядок событий и их причину невозможно.

Как правило, параметры даты и времени на маршрутизаторе или коммутаторе можно задать одним из двух способов. Можно вручную настроить дату и время, как показано в примере, или настроить протокол сетевого времени (NTP).

```
R1# clock set 16:01:00 sept 25 2020 
*Sep 25 16:01:00.000: %SYS-6-CLOCKUPDATE: System clock has been updated from 13:09:49 UTC Fri Sep 25 2020 to 16:01:00 UTC Fri Sep 25 2020, configured from console by console.
Sep 25 16:01:00.001: %PKI-6-AUTHORITATIVE_CLOCK: The system clock has been set.
R1#
```

По мере роста сети становится все труднее обеспечивать синхронизацию времени на всех устройствах инфраструктуры. И даже в небольшой сетевой среде ручной метод не является оптимальным вариантом. Если произошла перезагрузка маршрутизатора, как ему узнать точную дату и метку времени?

Более эффективным решением является настройка в сети протокола NTP. С помощью этого протокола маршрутизаторы по сети могут синхронизировать свои настройки времени с NTP-сервером. Клиенты NTP, которые получают сведения о времени и дате из одного источника, используют более корректные настройки времени. Если в сети реализован протокол NTP, его можно настроить на синхронизацию с частным тактовым генератором или общедоступным сервером NTP в Интернете.

Протокол NTP использует порт UDP 123 и задокументирован в RFC 1305.

<!-- 10.3.2 -->
## Работа протокола NTP

В сетях NTP используется иерархическая система источников времени. Каждый уровень этой иерархической системы называется часовым слоем (stratum). Уровень часового слоя определяется как количество переходов от доверенного источника. Для распределения синхронизированной информации о времени по сети используется протокол NTP. На рисунке показан пример сети NTP.

Серверы NTP расположены на трех уровнях, соответствующих трем часовым слоям. Часовой слой 1 подключен к часам часового слоя 0.

![](./assets/10.3.2.png)
<!-- /courses/ensa-dl/ae8eb392-34fd-11eb-ba19-f1886492e0e4/aeb5eaa2-34fd-11eb-ba19-f1886492e0e4/assets/c6af7f22-1c46-11ea-af56-e368b99e9723.svg -->

<!--
На рисунке показан пример сети NTP. Серверы NTP расположены на трех уровнях, соответствующих трем часовым слоям. Часовой слой&nbsp;1 подключен к часам часового слоя&nbsp;0. Stratum 0 состоит из двух часов NTP. Часы NTP подключены к 2 серверам NTP Stratum 1. Серверы NTP Stratum 1 подключены к 3 серверам NTP Stratum 2. Серверы NTP Stratum 2 подключены к 4 серверам NTP Stratum 3.
-->

**Часовой слой 0**

Сеть NTP получает информацию о времени от доверенных источников времени. Эти доверенные источники времени, также называемые устройствами часового слоя 0, являются высокоточными устройствами хранения времени, которые считаются точными и работают практически без задержек. Устройства слоя 0 изображены на рисунке в виде часов.

**Часовой слой 1**

Устройства слоя 1 подключены напрямую к доверенным источникам времени. Они выступают в роли основного стандарта сетевого времени.

**Часовой слой 2 и ниже**

Серверы часового слоя 2 подключены к устройствам часового слоя 1 через сеть. Устройства часового слоя 2, например клиенты NTP, синхронизируют свое время с помощью пакетов NTP, которые они получают от серверов часового слоя 1. Эти устройства могут также выступать в роли серверов для устройств часового слоя 3.

Чем меньше номер часового слоя, тем ближе сервер расположен к доверенному источнику времени. Чем больше номер часового слоя, тем ниже его уровень. Максимальное количество переходов равно 15. Часовой слой 16 имеет самый низкий уровень и указывает на то, что устройство не синхронизировано. Серверы времени, находящиеся в одном часовом слое, могут работать как равноправные серверы времени на одном уровне часового слоя для обеспечения резервирования или проверки правильности времени.

<!-- 10.3.3 -->
## Настройка и проверка NTP

На рисунке показана топология, используемая для демонстрации конфигурации и проверки NTP.

![](./assets/10.3.3.png)
<!-- /courses/ensa-dl/ae8eb392-34fd-11eb-ba19-f1886492e0e4/aeb5eaa2-34fd-11eb-ba19-f1886492e0e4/assets/c6aff450-1c46-11ea-af56-e368b99e9723.svg -->

<!--
На рисунке показана топология, демонстрирующая конфигурацию и проверку NTP. Сервер NTP расположен в облаке (Интернет) с IP-адресом 209.165.200.225. Маршрутизатор R1 помечен как NTP-сервер/клиент и имеет связь с облаком. R1 имеет IP-адрес 192.168.1.0/24. R1 также подключен к коммутатору S1, который также помечен как NTP-сервер/клиент. S1 имеет каналы связи с клиентами NTP, показанных как два человека за компьютерными столами.
-->

Перед настройкой протокола NTP в сети введите команду **show clock**, которая отображает текущее время программных часов, как показано в примере. Обратите внимание, что с опцией **detail** источником времени является пользовательская конфигурация. Это означает, что время было настроено вручную с помощью **clock** команды.

```
R1# show clock detail 
20:55:10.207 UTC Fri Nov 15 2019
Time source is user configuration
```

Команда **ntp server** _ip-address_ в режиме глобальной конфигурации используется, чтобы настроить адрес 209.165.200.225 в качестве сервера NTP для маршрутизатора R1. Чтобы убедиться, что в качестве источника времени выбран NTP, выполните команду **show clock detail** Обратите внимание, что теперь источником времени является NTP.

```
R1(config)# ntp server 209.165.200.225 
R1(config)# end 
R1# show clock detail 
21:01:34.563 UTC Fri Nov 15 2019
Time source is NTP
```

В следующем примере команды **show ntp associations** и **show ntp status** используются для проверки синхронизации R1 с сервером NTP в 209.165.200.225. Обратите внимание: маршрутизатор R1 синхронизирован с сервером NTP часового слоя 1 по адресу 209.165.200.225, который синхронизирован с часами GPS. Команда **show ntp status** показывает, что теперь маршрутизатор R1 является устройством часового слоя 2, которое синхронизировано с сервером NTP по адресу 209.165.220.225.

**Примечание**: Выделеный текст **st** обозначает слой.

```
R1# show ntp associations   
  address         ref clock       st   when   poll reach  delay  offset   disp
*~209.165.200.225 .GPS.           1     61     64   377  0.481   7.480  4.261
 * sys.peer, # selected, + candidate, - outlyer, x falseticker, ~ configured
 
R1# show ntp status 
Clock is synchronized, stratum 2, reference is 209.165.200.225
nominal freq is 250.0000 Hz, actual freq is 249.9995 Hz, precision is 2**19
ntp uptime is 589900 (1/100 of seconds), resolution is 4016
reference time is DA088DD3.C4E659D3 (13:21:23.769 PST Fri Nov 15 2019)
clock offset is 7.0883 msec, root delay is 99.77 msec
root dispersion is 13.43 msec, peer dispersion is 2.48 msec
loopfilter state is 'CTRL' (Normal Controlled Loop), drift is 0.000001803 s/s
system poll interval is 64, last update was 169 sec ago.
```

Затем часы на S1 настроены для синхронизации с R1 с помощью команды **ntp server**, а затем конфигурация проверяется с помощью команды **show ntp associations**, как показано на экране.

```
S1(config)# ntp server 192.168.1.1
S1(config)# end
S1# show ntp associations
  address         ref clock       st   when   poll reach  delay  offset   disp
*~192.168.1.1     209.165.200.225  2     12     64   377  1.066  13.616  3.840
 * sys.peer, # selected, + candidate, - outlyer, x falseticker, ~ configured
```

Команда **show ntp associations** позволяет убедиться, что часы на S1 теперь синхронизированы с R1 с адресом 192.168.1.1 по протоколу NTP. Маршрутизатор R1 является устройством часового слоя 2 и сервером NTP для коммутатора S1. Коммутатор S1 теперь является устройством часового слоя 3, которое может предоставлять службу NTP для остальных устройств в сети, например оконечных устройств.

```
S1# show ntp status
Clock is synchronized, stratum 3, reference is 192.168.1.1
nominal freq is 119.2092 Hz, actual freq is 119.2088 Hz, precision is 2**17
reference time is DA08904B.3269C655 (13:31:55.196 PST Tue Nov 15 2019)
clock offset is 18.7764 msec, root delay is 102.42 msec
root dispersion is 38.03 msec, peer dispersion is 3.74 msec
loopfilter state is 'CTRL' (Normal Controlled Loop), drift is 0.000003925 s/s
system poll interval is 128, last update was 178 sec ago.
```

<!-- 10.3.4 -->
## Packet Tracer. Настройка и проверка протокола NTP

Протокол NTP служит для синхронизации времени между распределенными серверами времени и клиентами. Существует довольно много приложений, для которых требуется синхронизация времени, однако в этой лабораторной работе рассматривается потребность корреляции событий, указанных в системном журнале, и других связанных со временем событий на нескольких сетевых устройствах.

[Настройка и проверка протокола NTP (pdf)](./assets/10.3.4-packet-tracer---configure-and-verify-ntp_ru-RU.pdf)

[Настройка и проверка протокола NTP (pka)](./assets/10.3.4-packet-tracer---configure-and-verify-ntp_ru-RU.pka)

