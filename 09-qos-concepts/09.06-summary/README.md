<!-- 9.6.1 -->
## Качество передачи данных по сети

От передачи голоса и видео в прямом эфире пользователи ждут более высокого качества доставки. Это создает потребность в качестве обслуживания (QoS). 

При агрегации нескольких каналов связи на одном устройстве, когда большая часть данных затем передается на меньшее число исходящих интерфейсов или на более медленный интерфейс, может возникнуть перегрузка. Это может также произойти, когда большие пакеты данных препятствуют своевременной передаче более мелких пакетов. Без механизмов качества обслуживания пакеты обрабатываются в порядке их получения. Из-за перегрузки сетевые устройства, такие как маршрутизаторы и коммутаторы, могут отбрасывать пакеты. Значит, чувствительные к задержкам пакеты (голосовая связь и видео в режиме реального времени) будут отбрасываться так же часто, как и нечувствительные к задержкам (электронная почта и страницы в Интернете). 

Когда объем трафика превышает возможности доставки по сети, устройства помещают пакеты в очередь и удерживают, пока не появятся ресурсы. Постановка пакетов в очередь приводит к задержке, поскольку новые пакеты не передаются, пока не будут обработаны предыдущие. Эту проблему решает метод QoS. Он распределяет данные по нескольким очередям. Точки перегрузки сети — идеальные кандидаты для механизмов QoS, чтобы снизить задержки. 

Задержки бывают фиксированные и переменные. Источники задержек: очередь, кодирование, пакетирование, сериализация, распространение, устранение джиттера. Джиттер — это разница в задержке полученных пакетов. В результате перегруженности сети, некорректной организации очереди или ошибок конфигурации время задержки для каждого пакета может меняться. И задержку, и джиттер необходимо контролировать и минимизировать, чтобы поддерживать интерактивный трафик в реальном времени.

## Характеристики трафика

Трафик голосовых данных и видеотрафик предъявляют высокие требования к сети. Это две основные причины реализации QoS. 

Голосовой трафик плавный и доброкачественный, но чувствителен к отбросу и задержкам. При передаче голоса допустимы определенные задержки, джиттер и потери без каких-либо заметных эффектов. Задержка не должна превышать 150 мс. Джиттер не должен превышать 30 мс, а потеря голосовых пакетов — 1 %. Для трафика голосовых данных требуется пропускная способность не менее 30 Кбит/с. 

Видеотрафик более требователен из-за размера пакетов, которые он отправляет по сети. Он пульсирующий, ресурсоемкий, чувствительный к потерям и задержкам и имеет высокий приоритет UDP. Без применения QoS и без значительного превышения требуемой полосы пропускания качество передачи видео обычно снижается. 

Портам UDP, например 554, которые используют для протокола потоковой передачи в режиме реального времени (RSTP), необходим более высокий приоритет, чем менее чувствительному к задержкам трафику. Видео, как и голос, может допускать определенный уровень задержки, джиттера и потерь без каких-либо заметных последствий. Задержка не должна превышать 400 миллисекунд (мс). Джиттер не должен превышать 50 мс, а потеря видеопакетов — 1 %. Для видеотрафика требуется пропускная способность не менее 384 Кбит/с. 

Трафик данных не так требователен, как голосовой и видеотрафик. Пакеты данных часто используют приложения TCP, которые ретранслируют данные и поэтому не чувствительны к падению и задержкам. Хотя трафик данных менее чувствителен к потерям и задержкам, чем голосовой трафик и видеотрафик, сетевому администратору необходимо учитывать качество взаимодействия с пользователями (QoE). Два основных фактора, которые администратор сети должен знать о потоке трафика данных, получены ли данные из интерактивного приложения и насколько важны данные.

## Алгоритмы организации очереди

Политика качества обслуживания, реализованная сетевым администратором, становится активной при заторе в канале связи. Организация очереди управляет затором, может выполнять буферизацию, приоритизацию и, если необходимо, изменить порядок пакетов перед их передачей. 

В курсе рассматриваются следующие алгоритмы очередей: «первым пришел — первым ушел» (FIFO), взвешенная организация очередь (WFQ), взвешенная организация очередей на основе классов (CBWFQ) и очередь с низкой задержкой (LLQ). 

Алгоритм очередей, в котором пакеты помещаются в буфер и пересылаются в порядке их получения — FIFO. В нем нет концепции приоритета или классов трафика. Когда используется FIFO, важный или чувствительный к задержкам трафик может отбрасываться при заторах в интерфейсе коммутатора или маршрутизатора. 

WFQ — автоматизированный метод планирования. Он справедливо выделяет полосы пропускания всему сетевому трафику. Для классификации трафика и разделения его на сеансы или потоки, в алгоритме WFQ применяют приоритеты или взвешенность. WFQ разделяет трафик на различные потоки с учетом адресации заголовков пакетов, включая такие характеристики, как IP-адреса источника и назначения, MAC-адреса, номера портов, протокол и значение типа обслуживания (Type of Service, ToS). Значение ToS в IP-заголовке может использоваться для классификации трафика. 

Возможности алгоритма CBWFQ шире, чем в стандартном алгоритме WFQ, из-зи поддержки определенных пользователем классов трафика. В CBWFQ вы определяете классы трафика по критериям соответствия, в том числе протоколам, ACL-спискам и входным интерфейсам. 

Функция LLQ строго формирует очереди по приоритетам (PQ) для CBWFQ. Строгий порядок формирования очередей (PQ) позволяет отправлять чувствительные к задержке данные, например голос, перед пакетами в других очередях.

## Модели обеспечения качества обслуживания

Модели реализации качества обслуживания: без гарантированной доставки, интегрированный сервис (IntServ) и дифференцированные услуги (DiffServ). 

Модель Best-effort — наиболее масштабируемая, но не гарантирует доставку и не дает пакетного преференциального режима. Потребности приложений реального времени, таких как потоковая видеопередача, мультимедийные конференции, визуализация и виртуальная реальность, стали стимулом разработать модель архитектуры IntServ, осуществленной в 1994 г. (RFC 1633, 2211 и 2212). 

Модель IntServ обеспечивает несколько уровней качества обслуживания. IntServ явно управляет сетевыми ресурсами, чтобы обеспечить качество обслуживания отдельных потоков или микропотоков. В этой модели в качестве базовых компонентов используются механизмы резервирования ресурсов и контроля доступа, которые позволяют определять политику качества обслуживания и обеспечивать ее выполнение. 

Модель дифференцированных сервисов (DiffServ) определяет простой и масштабируемый механизм для классификации и управления сетевым трафиком и гарантии качества обслуживания в современных IP-сетях. В DiffServ нет ограничений, свойственных модели без гарантированной доставки и IntServ. Модель DiffServ предоставляет «почти гарантированное» качество обслуживания, недорогая и масштабируемая. DiffServ делит сетевой трафик на классы, основываясь на требованиях бизнеса. После этого каждому классу можно назначить свой уровень обслуживания. При прохождении пакетов по сети каждое сетевое устройство определяет класс пакета и обрабатывает его в соответствии с требованиями для класса. Модель DiffServ предусматривает выбор из нескольких уровней обслуживания.

## Способы обеспечения качества обслуживания

Категории инструментов реализации гарантированной полосы пропускания: инструменты классификации и маркирования, инструменты предотвращения затора и инструменты управления перегруженностью. 

Чтобы применить к пакету политику качества обслуживания, его нужно классифицировать. Классификация и маркировка позволяют идентифицировать или «маркировать» типы пакетов. Классификация определяет класс трафика. При классификации потоков трафика на уровне 2 и 3 используют интерфейсы, списки контроля доступа и карты классов. Трафик также можно классифицировать на уровнях с 4-го по 7-й с помощью распознавания приложений по параметрам сетевого трафика (Network Based Application Recognition, NBAR). 

Тип службы (IPv4) и класс трафика (IPv6) несут маркировку пакетов, назначенную средствами классификации QoS. Получающие устройства сверяются с этим полем для пересылки пакетов на основании назначенной политики качества обслуживания. В этом поле выделено 6 бит для QoS. Оно называется полем точки кода дифференцирования трафика (DSCP) и за счет своих 6 бит предлагает до 64 возможных классов обслуживания. Получающие устройства сверяются с этим полем, чтобы переслать пакеты на основании назначенной политики QoS. 

64 значения DSCP разделены на три категории: Best-Effort (BE), Expedited Forwarding (EF), Assured Forwarding (AF). Поскольку первые три старших бита поля точки кода дифференцированных услуг определяют класс, эти биты называют битами селектора класса (Class Selector). 

Трафик нужно классифицировать и маркировать настолько близко к источнику, насколько это оправдано с технической и административной точки зрения. Это определяет границу доверия, как показано на рисунке. 

Управление заторами предусматривает планирование и формирование очередей, предполагающих буферизацию лишнего трафика или помещение его в очередь (а иногда и удаление) на время ожидания отправки такого трафика на выходном интерфейсе. Инструменты предотвращения перегрузок отслеживают распределение сетевого трафика, чтобы предугадать и предотвратить заторы в узких местах общей сети до возникновения серьезной проблемы. 

Cisco IOS предотвращает заторы с помощью механизма измеренного произвольного раннего обнаружения (Weighted Random Early Detection, WRED). Алгоритм WRED позволяет избегать заторов на сетевых интерфейсах за счет инструментов, которые управляют буферизацией и снижают или отбрасывают трафик TCP до того, как буфер переполнится. Шейпинг трафика и полисинг трафика — это механизмы Cisco IOS, позволяющие предотвращать заторы.

<!-- 9.6.2 -->
<!-- quiz -->
